name: Deploy FastAPI App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Run FastAPI App
        run: |
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 &

      - name: Install Zrok
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          ZROK_VERSION=$(curl -sSf https://api.github.com/repos/openziti/zrok/releases/latest | jq -r '.tag_name')
          case $(uname -m) in
            x86_64) GOXARCH=amd64 ;;
            aarch64|arm64) GOXARCH=arm64 ;;
            arm*) GOXARCH=armv7 ;;
            *) echo "ERROR: unknown arch '$(uname -m)'" >&2; exit 1 ;;
          esac
          curl -sSfL "https://github.com/openziti/zrok/releases/download/${ZROK_VERSION}/zrok_${ZROK_VERSION#v}_linux_${GOXARCH}.tar.gz" | tar -xz -f -
          sudo install -o root -g root ./zrok /usr/local/bin/
          zrok version

      - name: Start Zrok Tunnel
        run: |
          zrok enable "${{ secrets.ZROK_TOKEN }}"
          zrok share public http://localhost:8000/
